<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Keil Meal Planning</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a332a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
    body { font-family: 'DM Sans', sans-serif; background: #f2f5f3; color: #1a332a; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    .spinner { width:18px;height:18px;border-radius:50%;border:2.5px solid #d1ddd6;border-top-color:#8b6f47;animation:spin .8s linear infinite;display:inline-block;vertical-align:middle }
    @keyframes spin { to { transform:rotate(360deg) } }
    .slot-drop { transition: all .15s; }
    .slot-drop.over { background: #e6ece8 !important; border-color: #8b6f47 !important; transform: scale(1.02); }
    .scard { cursor: grab; transition: all .15s; }
    .scard:active { cursor: grabbing; opacity: .8; }
    ::-webkit-scrollbar { height:6px;width:6px }
    ::-webkit-scrollbar-thumb { background:#d1ddd6;border-radius:3px }
    input, textarea, select { font-family: 'DM Sans', sans-serif; }
    @keyframes pulse-border { 0%,100%{border-color:#8b6f47;box-shadow:0 0 0 0 rgba(139,111,71,.3)} 50%{border-color:#a8895e;box-shadow:0 0 0 6px rgba(139,111,71,0)} }
    .slot-targetable { animation: pulse-border 1.5s ease-in-out infinite; cursor: pointer !important; }
    .tap-selected { border-color: #8b6f47 !important; box-shadow: 0 0 0 3px rgba(139,111,71,.35) !important; }
    .tap-banner { position:fixed;bottom:0;left:0;right:0;z-index:100;background:linear-gradient(135deg,#1a332a,#2d5741);color:#f2f5f3;padding:10px 16px;padding-bottom:calc(10px + env(safe-area-inset-bottom));display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:14px;font-weight:600 }
    .slot-past { opacity:.55; pointer-events:auto; }
    .slot-past .slot-drop { cursor:default !important; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€â”€ Constants â”€â”€â”€
const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const SLOT_MAP = {
  Mon:["breakfast","lunch","dinner"],Tue:["breakfast","lunch","dinner"],Wed:["breakfast","lunch","dinner"],
  Thu:["breakfast","lunch","dinner"],Fri:["breakfast","lunch","dinner"],Sat:["breakfast","lunch","dinner"],
  Sun:["breakfast","lunch","dinner"]
};
const SERVINGS = "2 adults + 1 toddler";
const ALL_SLOTS = DAYS.flatMap(d => SLOT_MAP[d].map(t => `${d}-${t}`));

// Staple slot pattern: 21 entries (B/L/D Ã— 7).
// M-F: dinner only. Sat/Sun: lunch + dinner.  (9 staple slots, 12 open)
const STAPLE_PATTERN = [
  false,false,true,  false,false,true,  false,false,true,
  false,false,true,  false,false,true,  false,true,true,
  false,true,true
];

const STORE_SECTIONS = [
  ["Produce", ["broccoli","bell pepper","pepper","snap peas","zucchini","cherry tomato","tomato","onion","red onion","cucumber","spinach","baby spinach","ginger","garlic","lemon","lime","scallion","green onion","cilantro","basil","mushroom","bok choy","cabbage","lettuce","bean sprout","jalapeÃ±o","avocado","sweet potato","eggplant","corn","kale","arugula","shallot"]],
  ["Meat & Seafood", ["chicken","beef","flank steak","steak","pork","shrimp","salmon","fish","turkey","lamb","ground beef","ground turkey","chicken thigh","chicken breast"]],
  ["Dairy & Eggs", ["feta","cheese","yogurt","cream","butter","egg","milk","mozzarella","parmesan","sour cream"]],
  ["Tofu & Plant Protein", ["tofu","tempeh","edamame"]],
  ["Grains & Pasta", ["rice","jasmine rice","noodle","pasta","pita","bread","tortilla","couscous","quinoa","flatbread","wrap","udon","soba"]],
  ["Canned & Dry Goods", ["lentil","chickpea","black bean","coconut milk","tomato paste","tomato sauce","diced tomato","broth","stock","cornstarch","flour","sugar","panko","breadcrumb"]],
  ["Sauces & Condiments", ["soy sauce","oyster sauce","sesame oil","fish sauce","sriracha","gochujang","miso","tahini","vinegar","honey","teriyaki","hoisin","curry paste","hot sauce","worcestershire","hummus","olive oil","chili oil","sambal"]],
  ["Spices & Herbs", ["cumin","paprika","turmeric","coriander","oregano","chili flake","red pepper flake","curry powder","cinnamon","five spice","sesame seed","thyme","rosemary","bay leaf"]],
];

const DEFAULT_PREFS = {
  cuisines: ["Chinese","Asian","Mediterranean","Korean","Japanese","Thai","Mexican"],
  primaryCuisines: ["Chinese","Mediterranean"],
  dietaryNotes: "Low-sodium, heart-healthy. Birch tree allergy â€” avoid apples, pears, cherries, peaches, plums, apricots, kiwi, hazelnuts, almonds, walnuts, carrots (raw), celery (raw).",
  cookingStyle: "Quick prep, Sunday meal-prep friendly. Weeknight dinners under 30 min.",
  favoriteIngredients: ["rice","vegetables","chicken","beef","tofu","soy sauce","ginger","garlic","olive oil","lemon","chickpeas","lentils"],
  apiKey: "",
};

const DEFAULT_STAPLES = [
  {
    id:"s1", name:"Chicken Stir-Fry with Rice",
    description:"Quick wok-fried chicken with seasonal veggies and soy-ginger sauce over jasmine rice.",
    cuisine:"Asian", prepTime:"15 min", cookTime:"10 min", prepFriendly:true,
    whyYoullLikeIt:"Fast, flavorful, endlessly customizable with whatever veggies you have. Toddler-approved mild soy-ginger flavor.",
    ingredients:["1 lb chicken breast, sliced thin","1.5 cups jasmine rice","2 cups broccoli florets","1 bell pepper, sliced","1 cup snap peas","2 tbsp low-sodium soy sauce","1 tbsp sesame oil","1 inch ginger, minced","3 cloves garlic, minced","1 tsp cornstarch"],
    steps:["Toss chicken with soy sauce, cornstarch, sesame oil. Marinate 15 min or overnight.","Cook rice. Heat wok over high heat with sesame oil.","Stir-fry chicken 3â€“4 min. Remove. Stir-fry veggies 2â€“3 min.","Return chicken, add ginger + garlic, toss 30 sec. Serve over rice."],
  },
  {
    id:"s2", name:"Mediterranean Lentil Bowl",
    description:"Hearty lentils with roasted zucchini, cherry tomatoes, feta, and a bright lemon-herb dressing over baby spinach.",
    cuisine:"Mediterranean", prepTime:"10 min", cookTime:"25 min", prepFriendly:true,
    whyYoullLikeIt:"Warm, filling, and heart-healthy. Roasted veggies and feta add great texture. Lentils prep beautifully on Sunday.",
    ingredients:["1 cup green/brown lentils","1 medium zucchini, diced","1 cup cherry tomatoes, halved","Â½ red onion, diced","â…“ cup crumbled feta","3 tbsp olive oil","2 tbsp lemon juice","1 tsp oregano","Â½ tsp cumin","2 cups baby spinach"],
    steps:["Cook lentils with cumin until tender (~25 min). Drain.","Toss zucchini + onion with olive oil, roast at 425Â°F for 15 min.","Whisk olive oil, lemon juice, oregano for dressing.","Bowl: spinach, lentils, roasted veggies, tomatoes, feta + dressing."],
  },
  {
    id:"s3", name:"Beef & Broccoli",
    description:"Tender sliced flank steak and crisp broccoli in a savory low-sodium oyster sauce over steamed jasmine rice.",
    cuisine:"Chinese", prepTime:"15 min", cookTime:"10 min", prepFriendly:true,
    whyYoullLikeIt:"Classic comfort food that tastes better than takeout. Overnight marinating makes the beef melt-in-your-mouth tender.",
    ingredients:["1 lb flank steak, sliced thin","3 cups broccoli florets","1.5 cups jasmine rice","2 tbsp low-sodium oyster sauce","1 tbsp low-sodium soy sauce","1 tbsp sesame oil","1 inch ginger, minced","3 cloves garlic, minced","1 tsp cornstarch"],
    steps:["Toss steak with soy sauce, cornstarch, sesame oil. Marinate 15+ min.","Cook rice. Blanch broccoli 1â€“2 min, drain.","Sear beef in hot wok in batches, 1â€“2 min/side. Remove.","Add garlic + ginger 30 sec. Return beef, add broccoli + oyster sauce. Serve over rice."],
  },
  {
    id:"s4", name:"Chicken Shawarma Plates",
    description:"Warmly spiced chicken thighs with creamy hummus, a bright cucumber-tomato salad, and warm pita bread.",
    cuisine:"Mediterranean", prepTime:"15 min", cookTime:"12 min", prepFriendly:true,
    whyYoullLikeIt:"The spice blend smells incredible. Great for eating with your hands (toddler-friendly!). Overnight marinating = 12 min dinner.",
    ingredients:["1.5 lb chicken thighs, boneless","1 tsp each: cumin, paprika, turmeric, coriander","3 tbsp olive oil","1 lemon, juiced","Â½ cup hummus","1 cucumber, diced","2 tomatoes, diced","Â¼ red onion, sliced","4 pita breads"],
    steps:["Mix spices + olive oil + lemon. Coat chicken. Marinate overnight.","Make salad: cucumber, tomato, onion with oil + lemon.","Pan-sear chicken 5â€“6 min/side.","Warm pita. Slice chicken. Plate with hummus, salad, pita."],
  },
];

// â”€â”€â”€ Storage (localStorage for GitHub Pages) â”€â”€â”€
function load(key, fallback) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; }
}
function save(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) { console.error(e); }
}

// â”€â”€â”€ AI â”€â”€â”€
async function aiGenerate(prompt, apiKey, onError) {
  if (!apiKey) { onError("Add your Anthropic API key in Shop & Manage â†’ Preferences to generate ideas."); return null; }
  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514", max_tokens:4096,
        system:"You are a meal planning assistant. Return ONLY a valid JSON array. No markdown, no fences, no explanation.",
        messages:[{role:"user",content:prompt}],
      }),
    });
    if (!res.ok) { const t = await res.text(); onError(`API error ${res.status}: ${t.slice(0,120)}`); return null; }
    const data = await res.json();
    const text = data.content?.map(b => b.text||"").join("")||"";
    const m = text.match(/\[[\s\S]*\]/);
    return JSON.parse(m ? m[0] : text.replace(/```json|```/g,"").trim());
  } catch(e) { onError(e.message); return null; }
}

async function aiExpandRecipe(text, apiKey, onError) {
  if (!apiKey) { onError("Add your Anthropic API key in Shop & Manage â†’ Preferences to expand ideas."); return null; }
  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514", max_tokens:2048,
        system:`You are a meal planning assistant. The user will give you a meal idea (a name and optionally a short description). Turn it into a full recipe JSON object. Return ONLY a valid JSON object (not an array). No markdown, no fences, no explanation. Schema: {"name":"...","description":"One sentence overview","cuisine":"...","prepTime":"X min","cookTime":"Y min","prepFriendly":true/false,"whyYoullLikeIt":"1-2 sentences","ingredients":["qty + ingredient, for 2.5 servings"],"steps":["concise step"]}. Use 6-10 ingredients with quantities. 4-6 steps. Low sodium. No birch-allergy foods (apples, pears, cherries, peaches, plums, apricots, kiwi, hazelnuts, almonds, walnuts, raw carrots/celery).`,
        messages:[{role:"user",content:text}],
      }),
    });
    if (!res.ok) { const t = await res.text(); onError(`API error ${res.status}: ${t.slice(0,120)}`); return null; }
    const data = await res.json();
    const raw = data.content?.map(b => b.text||"").join("")||"";
    const cleaned = raw.replace(/```json|```/g,"").trim();
    const m = cleaned.match(/\{[\s\S]*\}/);
    return JSON.parse(m ? m[0] : cleaned);
  } catch(e) { onError(e.message); return null; }
}

function buildPrompt(prefs, staples, rejected, feedback) {
  const liked = Object.entries(feedback||{}).filter(([,v])=>v==="up").map(([k])=>k);
  const disliked = Object.entries(feedback||{}).filter(([,v])=>v==="down").map(([k])=>k);
  return `Generate exactly 10 dinner/lunch/breakfast dishes for 2 adults + 1 toddler.

PREFERENCES:
- Primary cuisines: ${prefs.primaryCuisines.join(", ")}
- Also welcome: ${prefs.cuisines.filter(c=>!prefs.primaryCuisines.includes(c)).join(", ")}
- Dietary: ${prefs.dietaryNotes}
- Cooking: ${prefs.cookingStyle}
- Favorite ingredients: ${prefs.favoriteIngredients.join(", ")}
- Staples (do NOT repeat): ${staples.map(s=>s.name).join(", ")}
${rejected.length ? `- Rejected (do NOT repeat): ${rejected.join(", ")}` : ""}
${liked.length ? `- Liked meals (generate similar): ${liked.join(", ")}` : ""}
${disliked.length ? `- Disliked meals (avoid similar): ${disliked.join(", ")}` : ""}

RULES:
- 6-10 core ingredients per dish with quantities for 2.5 servings (e.g. "1 lb chicken", "1.5 cups rice")
- Skip pantry basics (salt, pepper, cooking oil)
- 4-6 concise steps
- Under 30 min cook time, prioritize Sunday-prep-friendly
- 6-7 Chinese/Mediterranean, 3-4 from Korean/Japanese/Thai/Mexican/Indian
- No birch-allergy foods (apples, pears, cherries, peaches, plums, apricots, kiwi, hazelnuts, almonds, walnuts, raw carrots/celery)
- Low sodium
- Include a "whyYoullLikeIt" field: 1-2 sentences on what makes it special, flavors/textures, toddler-friendliness

JSON array, each object:
{"name":"...","description":"One sentence overview","cuisine":"...","prepTime":"X min","cookTime":"Y min","prepFriendly":true/false,"whyYoullLikeIt":"...","ingredients":["..."],"steps":["..."]}`;
}

// â”€â”€â”€ Week helpers â”€â”€â”€
function getMonday(d) { const x=new Date(d); const day=x.getDay(); x.setDate(x.getDate()-day+(day===0?-6:1)); x.setHours(0,0,0,0); return x; }
function weekKey(m) { return m.toISOString().slice(0,10); }
function fmtWeek(m) { const s=new Date(m); s.setDate(m.getDate()+6); return `${m.toLocaleDateString("en-US",{month:"short",day:"numeric"})} â€“ ${s.toLocaleDateString("en-US",{month:"short",day:"numeric"})}`; }
function shiftWeek(m,d) { const x=new Date(m); x.setDate(x.getDate()+7*d); return x; }

// â”€â”€â”€ Styles â”€â”€â”€
const C = { bg:"#f2f5f3",card:"#ffffff",dark:"#1a332a",med:"#2d5741",light:"#5a7d6a",accent:"#8b6f47",green:"#3d6b50",border:"#d1ddd6",red:"#c1666b",white:"#fff",warm:"#e6ece8" };
const btn = (bg,fg,x={}) => ({background:bg,color:fg,border:"none",borderRadius:8,padding:"8px 16px",fontSize:13,fontWeight:600,cursor:"pointer",fontFamily:"'DM Sans',sans-serif",transition:"all .15s",...x});
const secH = {fontFamily:"'Playfair Display',serif",fontSize:14,color:C.dark,margin:"14px 0 4px",borderBottom:`1px solid ${C.border}`,paddingBottom:4};

// â”€â”€â”€ RecipeModal â”€â”€â”€
function RecipeModal({meal,onClose,staples,onPromote}) {
  if (!meal) return null;
  const isSt = staples.some(s=>s.name===meal.name);
  return (
    <div style={{position:"fixed",inset:0,background:"rgba(26,51,42,.5)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={onClose}>
      <div onClick={e=>e.stopPropagation()} style={{background:C.card,borderRadius:18,maxWidth:560,width:"100%",maxHeight:"85vh",overflow:"auto",padding:"24px 28px",position:"relative",boxShadow:"0 20px 60px rgba(26,51,42,.3)"}}>
        <button onClick={onClose} style={{position:"absolute",top:12,right:16,background:"none",border:"none",fontSize:22,cursor:"pointer",color:C.light}}>Ã—</button>
        <h2 style={{fontFamily:"'Playfair Display',serif",color:C.dark,fontSize:21,margin:"0 0 4px",paddingRight:28}}>{meal.name}</h2>
        <p style={{fontSize:13,color:C.light,margin:"0 0 12px"}}>{meal.description}</p>
        <div style={{display:"flex",gap:10,flexWrap:"wrap",fontSize:12,color:C.green,marginBottom:14}}>
          <span>ğŸ³ {meal.cuisine}</span><span>â± Prep {meal.prepTime} Â· Cook {meal.cookTime}</span>
          {meal.prepFriendly && <span>ğŸ“¦ Sunday prep</span>}<span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ {SERVINGS}</span>
        </div>
        {meal.whyYoullLikeIt && (
          <div style={{background:"#e6ece8",borderRadius:10,padding:"10px 14px",marginBottom:14,fontSize:13,color:C.med,lineHeight:1.6,borderLeft:`3px solid ${C.green}`}}>
            ğŸŒ¿ <strong>Why you'll like it:</strong> {meal.whyYoullLikeIt}
          </div>
        )}
        <h3 style={secH}>Ingredients</h3>
        <ul style={{fontSize:13,color:C.dark,paddingLeft:18,lineHeight:2,margin:"4px 0 0"}}>{meal.ingredients?.map((ing,i)=><li key={i}>{ing}</li>)}</ul>
        <h3 style={secH}>Steps</h3>
        <ol style={{fontSize:13,color:C.dark,paddingLeft:18,lineHeight:1.8,margin:"4px 0 0"}}>{meal.steps?.map((s,i)=><li key={i} style={{marginBottom:5}}>{s}</li>)}</ol>
        <div style={{marginTop:16,display:"flex",gap:8,flexWrap:"wrap"}}>
          <button onClick={()=>{const t=`ğŸ½ ${meal.name} (${SERVINGS})\n\nğŸ“ Ingredients:\n${meal.ingredients.map(i=>`â€¢ ${i}`).join("\n")}\n\nğŸ‘¨â€ğŸ³ Steps:\n${meal.steps.map((s,i)=>`${i+1}. ${s}`).join("\n")}`;navigator.clipboard.writeText(t);}} style={btn(C.accent,C.white)}>Copy Recipe ğŸ“‹</button>
          {!isSt && <button onClick={()=>onPromote(meal)} style={btn(C.green,C.white)}>â­ Make Staple</button>}
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Main App â”€â”€â”€
function App() {
  const [page, setPage] = useState("plan");
  const [prefs, setPrefs] = useState(()=>load("mp4-prefs",DEFAULT_PREFS));
  const [staples, setStaples] = useState(()=>load("mp4-staples",DEFAULT_STAPLES));
  const [pantry, setPantry] = useState(()=>{
    const saved = load("mp4-pantry",null);
    // Migrate flat array â†’ sectioned format
    if (Array.isArray(saved)) return {"Uncategorized":saved};
    if (saved) return saved;
    return {
      "Proteins":["chicken","beef","bacon","sausage"],
      "Grains & Bread":["rice","pasta","bread","tortillas","pancake mix","bagels","wheat thins"],
      "Canned & Dry":["beans","tomato soup","peanut butter","strawberry jelly"],
      "Dairy & Fridge":["milk","cheese","butter","cream cheese","strawberry chobani yogurt"],
      "Frozen":["frozen strawberries","frozen mixed veggies"],
      "Spices & Basics":["salt","pepper","olive oil","sugar","flour","garlic powder","onion powder","paprika","cumin","oregano","chili flake","soy sauce","sesame oil","vinegar","honey"],
    };
  });
  const [allWeeks, setAllWeeks] = useState(()=>load("mp4-weeks",{}));
  const [currentMonday, setCurrentMonday] = useState(()=>{const t=new Date();const m=getMonday(t);return t.getDay()===6?shiftWeek(m,1):m;});
  const [suggestions, setSuggestions] = useState([]);
  const [rejected, setRejected] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [modal, setModal] = useState(null);
  const [dragItem, setDragItem] = useState(null);
  const [dragOver, setDragOver] = useState(null);
  const [editPrefs, setEditPrefs] = useState(false);
  const [apiKeyVisible, setApiKeyVisible] = useState(false);
  const [tapSelected, setTapSelected] = useState(null); // { meal, fromSlot } or null
  const [customText, setCustomText] = useState("");
  const [customLoading, setCustomLoading] = useState(false);
  const [pantryInput, setPantryInput] = useState("");
  const [feedback, setFeedback] = useState(()=>load("mp4-feedback",{}));
  const [editingSlot, setEditingSlot] = useState(null);
  const [slotInput, setSlotInput] = useState("");
  const [stapleInput, setStapleInput] = useState("");
  const [checkedItems, setCheckedItems] = useState(()=>load("mp4-checked",{}));
  const [cooks, setCooks] = useState(()=>load("mp4-cooks",{}));
  const [lockedSlots, setLockedSlots] = useState(()=>load("mp4-locked",{}));

  const wk = weekKey(currentMonday);
  const weekSlots = allWeeks[wk] || {};
  const longPressRef = useRef(false);

  // Save on change
  useEffect(()=>save("mp4-staples",staples),[staples]);
  useEffect(()=>save("mp4-pantry",pantry),[pantry]);
  useEffect(()=>save("mp4-prefs",prefs),[prefs]);
  useEffect(()=>save("mp4-weeks",allWeeks),[allWeeks]);
  useEffect(()=>save("mp4-feedback",feedback),[feedback]);
  useEffect(()=>save("mp4-checked",checkedItems),[checkedItems]);
  useEffect(()=>save("mp4-cooks",cooks),[cooks]);
  useEffect(()=>save("mp4-locked",lockedSlots),[lockedSlots]);

  // â”€â”€ Auto-populate staples on empty weeks â”€â”€
  useEffect(()=>{
    const existing = allWeeks[wk];
    if (existing && Object.keys(existing).length > 0) return; // already has meals
    if (staples.length === 0) return;
    const newSlots = {};
    let si = 0;
    ALL_SLOTS.forEach((slotKey, i) => {
      if (STAPLE_PATTERN[i] && staples.length > 0) {
        newSlots[slotKey] = staples[si % staples.length];
        si++;
      }
    });
    setAllWeeks(prev => ({...prev, [wk]: newSlots}));
  }, [wk, staples.length]);

  // Slot helpers
  const setSlot = (sk, meal) => setAllWeeks(p=>({...p,[wk]:{...p[wk],[sk]:meal}}));
  const clearSlot = (sk) => setAllWeeks(p=>{const w={...(p[wk]||{})};delete w[sk];return{...p,[wk]:w};});
  const pantryFlat = Object.values(pantry).flat();
  const assignedNames = new Set(ALL_SLOTS.map(k=>weekSlots[k]?.name).filter(Boolean));
  const filledCount = ALL_SLOTS.filter(k=>weekSlots[k]).length;

  // Generate
  const generate = async () => {
    setLoading(true); setError(null);
    const result = await aiGenerate(buildPrompt(prefs,staples,rejected,feedback), prefs.apiKey, setError);
    if (result && Array.isArray(result)) setSuggestions(result.map((m,i)=>({...m,id:"g"+Date.now()+"_"+i})));
    setLoading(false);
  };

  // Expand custom meal idea
  const expandCustom = async () => {
    if (!customText.trim()) return;
    setCustomLoading(true); setError(null);
    const meal = await aiExpandRecipe(customText.trim(), prefs.apiKey, setError);
    if (meal) {
      setSuggestions(p => [{...meal, id:"c"+Date.now()}, ...p]);
      setCustomText("");
    }
    setCustomLoading(false);
  };

  // Inline slot add (title only)
  const addSlotMeal = (sk) => {
    if (!slotInput.trim()) return;
    setSlot(sk, {name:slotInput.trim(), id:"i"+Date.now()});
    setEditingSlot(null); setSlotInput("");
  };

  // Add random staple to slot
  const addRandomStaple = (sk) => {
    if (staples.length === 0) return;
    const s = staples[Math.floor(Math.random()*staples.length)];
    setSlot(sk, s);
    setEditingSlot(null);
  };

  // Re-roll all staple slots (shuffle staples into STAPLE_PATTERN slots, skip locked)
  const rerollStaples = () => {
    if (staples.length === 0) return;
    const shuffled = [...staples].sort(()=>Math.random()-0.5);
    const newSlots = {...(allWeeks[wk]||{})};
    let si = 0;
    ALL_SLOTS.forEach((slotKey, i) => {
      if (STAPLE_PATTERN[i] && !lockedSlots[`${wk}::${slotKey}`]) {
        newSlots[slotKey] = shuffled[si % shuffled.length];
        si++;
      }
    });
    setAllWeeks(prev => ({...prev, [wk]: newSlots}));
  };
  const toggleLock = (sk) => {
    const key = `${wk}::${sk}`;
    setLockedSlots(p => {const n={...p}; if(n[key]) delete n[key]; else n[key]=true; return n;});
  };

  // Add staple (title only)
  const addStapleDirect = () => {
    if (!stapleInput.trim()) return;
    setStaples(p => [...p, {name:stapleInput.trim(), id:"s"+Date.now()}]);
    setStapleInput("");
  };

  // Generate full recipe for an existing title-only meal
  const [expanding, setExpanding] = useState(null); // meal id being expanded
  const generateRecipe = async (meal, updateFn) => {
    setExpanding(meal.id); setError(null);
    const full = await aiExpandRecipe(meal.name, prefs.apiKey, setError);
    if (full) updateFn({...full, id:meal.id});
    setExpanding(null);
  };

  // Drag & drop
  const onDragStart = (e,meal,fromSlot) => { setTapSelected(null); setDragItem({meal,fromSlot}); e.dataTransfer.effectAllowed="move"; try{e.dataTransfer.setData("text/plain",meal.name)}catch{} };
  const onDragOverSlot = (e,sk) => { e.preventDefault(); setDragOver(sk); };
  const onDragLeave = () => setDragOver(null);
  const onDrop = (e,sk) => { e.preventDefault(); setDragOver(null); if(!dragItem)return; if(dragItem.fromSlot) clearSlot(dragItem.fromSlot); setSlot(sk,dragItem.meal); setDragItem(null); };
  const onDragEnd = () => { setDragItem(null); setDragOver(null); };

  // Tap-to-place (touch-friendly alternative to drag-and-drop)
  const tapSelectMeal = (meal, fromSlot) => {
    setTapSelected(prev => (prev && prev.meal.name === meal.name && prev.fromSlot === fromSlot) ? null : { meal, fromSlot });
  };
  const tapPlaceInSlot = (sk) => {
    if (!tapSelected) return;
    if (tapSelected.fromSlot) clearSlot(tapSelected.fromSlot);
    setSlot(sk, tapSelected.meal);
    setTapSelected(null);
  };
  const tapCancel = () => setTapSelected(null);

  // Shopping list
  const getShopList = () => {
    const map={},seen={};
    Object.values(weekSlots).forEach(meal=>{
      if(!meal?.ingredients) return;
      meal.ingredients.forEach(ing=>{
        const norm=ing.toLowerCase().replace(/[Â½Â¼Â¾â…“â…”â…›]+/g,"").trim();
        const nm=norm.match(/^([\d./Â½Â¼Â¾â…“â…”â…›]+\s*(?:lb|lbs|oz|cups?|tbsp|tsp|inch|inches|cloves?|medium|large|small|bunch|cans?|can|pkg|package)?\s*(?:of\s)?)?(.+)/i);
        const raw=nm&&nm[2]?nm[2].replace(/,.*$/,"").trim().replace(/\s+/g," "):norm;
        const base=raw.replace(/^(lbs?|oz|cups?|tbsp|tsp|inches?|cloves?|bunch(?:es)?|cans?|pkg|packages?|heads?|pieces?)\s+/i,"").trim()||raw;
        const qty=nm&&nm[1]?nm[1].trim():"";
        const mk=`${meal.name}::${base}`;
        if(seen[mk])return; seen[mk]=true;
        if(!map[base]) map[base]={name:base.replace(/\b\w/g,c=>c.toUpperCase()),quantities:[],key:base};
        if(qty && !map[base].quantities.includes(qty)) map[base].quantities.push(qty);
      });
    });
    // Filter out pantry items (fuzzy: strips adjectives, handles plurals + substring matching)
    const ADJ = /\b(fresh|dried|ground|boneless|skinless|large|medium|small|thin|thick|chopped|diced|sliced|minced|whole|raw|cooked|low-sodium|reduced-sodium)\s*/gi;
    const normP = s => s.replace(ADJ,'').replace(/\s+/g,' ').trim();
    const items = Object.values(map).filter(item => {
      const ci = normP(item.key);
      return !pantryFlat.some(p => {
        const cp = normP(p);
        if (!cp) return false;
        if (ci === cp || ci+'s' === cp || ci === cp+'s') return true;
        return ci.includes(cp) || cp.includes(ci);
      });
    });
    const grouped = [];
    const used = new Set();
    STORE_SECTIONS.forEach(([section, keywords]) => {
      const matches = items.filter(item => !used.has(item.key) && keywords.some(kw => item.key.includes(kw)));
      matches.forEach(m => used.add(m.key));
      if (matches.length) grouped.push({ section, items: matches.sort((a,b) => a.key.localeCompare(b.key)) });
    });
    const other = items.filter(item => !used.has(item.key)).sort((a,b) => a.key.localeCompare(b.key));
    if (other.length) grouped.push({ section: "Other", items: other });
    return grouped;
  };

  const promoteToStaple = (meal) => { if(staples.find(s=>s.name===meal.name)) return; setStaples(p=>[...p,{...meal,id:"s"+Date.now()}]); };

  // PDF export
  const exportPDF = () => {
    const rows = ALL_SLOTS.map(k=>{const meal=weekSlots[k]; if(!meal) return `<tr style="border-bottom:1px solid #d1ddd6"><td style="padding:8px 12px;color:#5a7d6a;width:100px">${k.replace("-"," Â· ").toUpperCase()}</td><td style="padding:8px 12px;color:#b0c4b8;font-style:italic">â€”</td></tr>`; const isSt=staples.some(s=>s.name===meal.name); return `<tr style="border-bottom:1px solid #d1ddd6"><td style="padding:8px 12px;font-weight:700;color:#1a332a;width:100px">${k.replace("-"," Â· ").toUpperCase()}</td><td style="padding:8px 12px"><strong>${isSt?'â­':'âœ¨'} ${meal.name}</strong><br><span style="font-size:11px;color:#5a7d6a">${meal.cuisine} Â· Cook ${meal.cookTime}${meal.prepFriendly?' Â· ğŸ“¦':''}</span></td></tr>`;}).join("");
    const recipes=[...new Map(ALL_SLOTS.map(k=>weekSlots[k]).filter(Boolean).map(m=>[m.name,m])).values()];
    const recipeHTML=recipes.map(m=>`<div style="break-inside:avoid;border:1.5px solid #d1ddd6;border-radius:10px;padding:16px 20px;margin-bottom:14px;background:#ffffff"><div style="border-left:4px solid #3d6b50;padding-left:12px;margin-bottom:10px"><strong style="font-size:16px">${m.name}</strong><br><span style="font-size:11px;color:#5a7d6a">${m.cuisine} Â· Prep ${m.prepTime} Â· Cook ${m.cookTime} Â· ${SERVINGS}</span></div><div style="display:flex;gap:20px"><div style="flex:1"><strong style="font-size:12px">Ingredients</strong><ul style="font-size:11px;padding-left:16px;line-height:1.8;margin:4px 0 0">${m.ingredients.map(i=>`<li>${i}</li>`).join("")}</ul></div><div style="flex:1.2"><strong style="font-size:12px">Steps</strong><ol style="font-size:11px;padding-left:16px;line-height:1.7;margin:4px 0 0">${m.steps.map(s=>`<li style="margin-bottom:3px">${s}</li>`).join("")}</ol></div></div></div>`).join("");
    const shopGroups=getShopList();
    const shopTotal=shopGroups.reduce((n,g)=>n+g.items.length,0);
    const shopRows=shopGroups.map(g=>`<tr style="background:#e6ece8"><td colspan="2" style="padding:8px 12px;font-weight:700;font-size:12px;color:#2d5741;text-transform:uppercase;letter-spacing:.5px">${g.section}</td></tr>${g.items.map(i=>`<tr style="border-bottom:1px solid #d1ddd6"><td style="padding:5px 10px;width:24px">â˜</td><td style="padding:5px 10px;font-size:13px">${i.name}${i.quantities.length?` <span style="color:#5a7d6a;font-size:11px">(${i.quantities.join(" + ")})</span>`:""}</td></tr>`).join("")}`).join("");
    const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Meal Plan â€“ ${fmtWeek(currentMonday)}</title><style>@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;600;700&display=swap');*{box-sizing:border-box;margin:0;padding:0}body{font-family:'DM Sans',sans-serif;color:#1a332a}@media print{body{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}.pb{break-before:page}}@page{margin:.5in}</style></head><body><div style="background:linear-gradient(135deg,#1a332a,#2d5741);padding:22px 26px;border-radius:10px;margin-bottom:18px"><div style="font-family:'Playfair Display',serif;font-size:24px;font-weight:700;color:#f2f5f3">Keil Meal Planning</div><div style="font-size:12px;color:#a8c4b0;margin-top:3px">${fmtWeek(currentMonday)} Â· ${SERVINGS}</div></div><table style="width:100%;border-collapse:collapse;border:1.5px solid #d1ddd6;margin-bottom:24px"><thead><tr style="background:#3d6b50"><th style="padding:8px 12px;text-align:left;color:#fff;font-size:12px">SLOT</th><th style="padding:8px 12px;text-align:left;color:#fff;font-size:12px">MEAL</th></tr></thead><tbody>${rows}</tbody></table><div class="pb"></div><div style="background:linear-gradient(135deg,#1a332a,#2d5741);padding:16px 22px;border-radius:10px;margin-bottom:14px"><div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:#f2f5f3">ğŸ›’ Shopping List Â· ${shopTotal} items</div></div><table style="width:100%;border-collapse:collapse;border:1.5px solid #d1ddd6;margin-bottom:24px"><tbody>${shopRows}</tbody></table><div class="pb"></div><div style="background:linear-gradient(135deg,#1a332a,#2d5741);padding:16px 22px;border-radius:10px;margin-bottom:14px"><div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:#f2f5f3">ğŸ“– Recipes</div></div>${recipeHTML}</body></html>`;
    const blob=new Blob([html],{type:"text/html"});const url=URL.createObjectURL(blob);const w=window.open(url,"_blank");if(w) w.onload=()=>setTimeout(()=>w.print(),400);
  };

  // â”€â”€â”€ RENDER â”€â”€â”€
  return (
    <div style={{minHeight:"100vh",background:C.bg}}>
      {/* Top bar */}
      <div style={{background:`linear-gradient(135deg,${C.dark},${C.med})`,padding:"14px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:8}}>
        <h1 style={{fontFamily:"'Playfair Display',serif",fontSize:20,fontWeight:800,color:C.card,margin:0,whiteSpace:"nowrap"}}>Keil Meal Planning</h1>
        <div style={{display:"flex",gap:6}}>
          {[{id:"plan",l:"ğŸ“… Plan"},{id:"manage",l:"ğŸ›’ Shop & Manage"}].map(t=>(
            <button key={t.id} onClick={()=>setPage(t.id)} style={{background:page===t.id?C.accent:"rgba(255,255,255,.12)",color:C.white,border:"none",borderRadius:8,padding:"7px 12px",fontSize:13,fontWeight:600,cursor:"pointer",fontFamily:"'DM Sans',sans-serif"}}>{t.l}</button>
          ))}
        </div>
      </div>

      {/* Tap-to-place banner */}
      {tapSelected && (
        <div className="tap-banner">
          <span>Placing: <strong>{tapSelected.meal.name}</strong></span>
          <button onClick={tapCancel} style={btn("rgba(255,255,255,.2)",C.white,{padding:"5px 14px",fontSize:12,borderRadius:6})}>Cancel</button>
        </div>
      )}

      {/* â•â•â• PLAN PAGE â•â•â• */}
      {page === "plan" && (
        <div style={{paddingBottom:40}}>
          {/* Week nav */}
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:14,padding:"14px 16px",background:C.card,borderBottom:`1px solid ${C.border}`}}>
            <button onClick={()=>setCurrentMonday(shiftWeek(currentMonday,-1))} style={btn("transparent",C.dark,{fontSize:18,padding:"4px 10px",border:`1.5px solid ${C.border}`,borderRadius:8})}>â€¹</button>
            <div style={{textAlign:"center"}}>
              <div style={{fontFamily:"'Playfair Display',serif",fontSize:17,fontWeight:700,color:C.dark}}>{fmtWeek(currentMonday)}</div>
              <div style={{fontSize:12,color:C.light,marginTop:1}}>{filledCount}/{ALL_SLOTS.length} meals planned</div>
            </div>
            <button onClick={()=>setCurrentMonday(shiftWeek(currentMonday,1))} style={btn("transparent",C.dark,{fontSize:18,padding:"4px 10px",border:`1.5px solid ${C.border}`,borderRadius:8})}>â€º</button>
          </div>

          {/* Week strip */}
          <div style={{overflowX:"auto",padding:"14px 10px 6px",background:`linear-gradient(180deg,${C.card} 0%,${C.bg} 100%)`}}>
            <div style={{display:"flex",gap:7}}>
              {DAYS.map((day,di)=>{
                const isWE = day==="Sat"||day==="Sun";
                const dt = new Date(currentMonday); dt.setDate(currentMonday.getDate()+di);
                const today = new Date(); today.setHours(0,0,0,0);
                const dayDate = new Date(dt); dayDate.setHours(0,0,0,0);
                const isPast = dayDate < today;
                const isToday = dayDate.getTime()===today.getTime();
                const COOK_COLORS = {CK:"#3b82f6",MC:"#ef4444"};
                return (
                  <div key={day} style={{flex:1,minWidth:120,background:isPast?"#e8ecea":isWE?C.warm:C.card,border:`2px solid ${isToday?C.green:C.border}`,borderRadius:12,padding:"10px 8px 8px",opacity:isPast?0.5:1,boxShadow:isToday?`0 0 0 2px ${C.green}33`:undefined}}>
                    <div style={{textAlign:"center",marginBottom:8}}>
                      <div style={{fontSize:11,fontWeight:700,color:C.light,textTransform:"uppercase",letterSpacing:.5}}>{day}</div>
                      <div style={{fontSize:10,color:C.light}}>{dt.toLocaleDateString("en-US",{month:"short",day:"numeric"})}</div>
                    </div>
                    {SLOT_MAP[day].map(type=>{
                      const sk=`${day}-${type}`;const meal=weekSlots[sk];const isOver=dragOver===sk&&!isPast;
                      const isTargetable=tapSelected&&!meal&&!isPast;
                      const isTapSel=tapSelected&&meal&&tapSelected.meal.name===meal.name&&tapSelected.fromSlot===sk;
                      const isMenu=editingSlot==="menu:"+sk;
                      const isTyping=editingSlot==="type:"+sk;
                      const isEditing=isMenu||isTyping;
                      const badgeLabel=type==="breakfast"?"B":type==="lunch"?"L":"D";
                      const cookKey=`${wk}::${sk}`;
                      const cook=cooks[cookKey];
                      const cookColor=cook?COOK_COLORS[cook]:null;
                      const toggleCook=()=>setCooks(p=>{const next=!p[cookKey]?"CK":p[cookKey]==="CK"?"MC":undefined;const n={...p};if(next)n[cookKey]=next;else delete n[cookKey];return n;});
                      return (
                        <div key={sk} className={`slot-drop ${isOver?'over':''} ${isTargetable?'slot-targetable':''} ${isTapSel?'tap-selected':''}`}
                          onDragOver={e=>{if(!isPast)onDragOverSlot(e,sk);}} onDragLeave={onDragLeave} onDrop={e=>{if(!isPast)onDrop(e,sk);}}
                          onClick={()=>{
                            if(isPast) return;
                            if(tapSelected&&!meal){tapPlaceInSlot(sk);}
                            else if(!tapSelected&&!meal&&!editingSlot){setEditingSlot("menu:"+sk);}
                          }}
                          style={{minHeight:48,borderRadius:8,marginBottom:4,border:`1.5px ${meal?'solid':'dashed'} ${isOver||isTargetable?C.accent:cookColor||C.border}`,borderLeft:cookColor?`4px solid ${cookColor}`:undefined,background:meal?(cookColor?cookColor+"12":C.card):"transparent",padding:meal?"5px 7px":"5px 7px",cursor:isTargetable?"pointer":((!meal&&!isPast)?"text":"default")}}>
                          <div style={{fontSize:9,fontWeight:700,color:C.light,textTransform:"uppercase",letterSpacing:.5,marginBottom:2,display:"flex",alignItems:"center",gap:4}}>
                            <span style={{background:C.light,color:C.white,borderRadius:3,padding:"0 4px",fontSize:8,lineHeight:"14px"}}>{badgeLabel}</span>
                            {type}
                          </div>
                          {meal ? (
                            <div draggable={!isPast} onDragStart={e=>{if(!isPast)onDragStart(e,meal,sk);}} onDragEnd={onDragEnd}
                              onClick={(e)=>{ if(e.target.closest('button')||longPressRef.current) return; setModal(meal); }}
                              onTouchStart={(e)=>{
                                if(isPast||e.target.closest('button')) return;
                                longPressRef.current=false;
                                const t=setTimeout(()=>{longPressRef.current=true;tapSelectMeal(meal,sk);},500);
                                const el=e.currentTarget;
                                const end=()=>{clearTimeout(t);el.removeEventListener('touchend',end);el.removeEventListener('touchmove',move);};
                                const move=()=>{clearTimeout(t);longPressRef.current=false;el.removeEventListener('touchend',end);el.removeEventListener('touchmove',move);};
                                el.addEventListener('touchend',end,{once:true});
                                el.addEventListener('touchmove',move,{once:true});
                              }}
                              onTouchEnd={()=>{setTimeout(()=>{longPressRef.current=false;},50);}}
                              onContextMenu={e=>{if(!isPast){e.preventDefault();tapSelectMeal(meal,sk);}}}
                              style={{cursor:"pointer"}}>
                              <div style={{fontSize:11,fontWeight:700,color:C.dark,lineHeight:1.3}}>{meal.name}</div>
                              {meal.cuisine && <div style={{fontSize:9,color:C.light,marginTop:1}}>{meal.cuisine} Â· {meal.cookTime}</div>}
                              <div style={{display:"flex",gap:3,marginTop:3,flexWrap:"wrap",alignItems:"center"}}>
                                {!meal.ingredients && (
                                  <button onClick={(e)=>{e.stopPropagation();generateRecipe(meal,m=>setSlot(sk,m));}} disabled={expanding===meal.id}
                                    style={btn(C.accent,C.white,{padding:"2px 5px",fontSize:8,borderRadius:4,opacity:expanding===meal.id?0.6:1})}>
                                    {expanding===meal.id?<span className="spinner" style={{width:10,height:10}}/>:"Generate Recipe"}</button>
                                )}
                                <button onClick={toggleCook}
                                  style={btn(cook?COOK_COLORS[cook]:"#e2e8f0",cook?"#fff":"#64748b",{padding:"2px 6px",fontSize:8,borderRadius:4,fontWeight:800,letterSpacing:.5,minWidth:26})}>
                                  {cook||"â€”"}
                                </button>
                                {isPast ? (
                                  <>
                                    <button onClick={()=>setFeedback(p=>({...p,[meal.name]:p[meal.name]==="up"?undefined:"up"}))}
                                      style={btn(feedback[meal.name]==="up"?C.green:"transparent",feedback[meal.name]==="up"?C.white:C.green,{padding:"2px 5px",fontSize:8,borderRadius:4,border:`1px solid ${C.green}`})}>âœ“</button>
                                    <button onClick={()=>setFeedback(p=>({...p,[meal.name]:p[meal.name]==="down"?undefined:"down"}))}
                                      style={btn(feedback[meal.name]==="down"?C.red:"transparent",feedback[meal.name]==="down"?C.white:C.red,{padding:"2px 5px",fontSize:8,borderRadius:4,border:`1px solid ${C.red}`})}>Ã—</button>
                                  </>
                                ) : (
                                  <>
                                    <button onClick={()=>toggleLock(sk)}
                                      style={btn(lockedSlots[`${wk}::${sk}`]?"#f59e0b":"transparent",lockedSlots[`${wk}::${sk}`]?"#fff":"#f59e0b",{padding:"2px 5px",fontSize:8,borderRadius:4,border:`1px solid #f59e0b`})}>{lockedSlots[`${wk}::${sk}`]?"ğŸ”’":"ğŸ”“"}</button>
                                    <button onClick={()=>clearSlot(sk)} style={btn("transparent",C.red,{padding:"2px 5px",fontSize:8,borderRadius:4,border:`1px solid ${C.red}`})}>Ã—</button>
                                  </>
                                )}
                              </div>
                            </div>
                          ) : isMenu ? (
                            <div style={{display:"flex",flexDirection:"column",gap:3}} onClick={e=>e.stopPropagation()}>
                              {staples.length>0 && <select autoFocus onChange={e=>{if(e.target.value){const s=staples.find(x=>x.id===e.target.value);if(s){setSlot(sk,s);setEditingSlot(null);}}}} defaultValue=""
                                style={{padding:"3px 4px",borderRadius:5,border:`1px solid ${C.border}`,fontSize:10,color:C.dark,background:C.white}}>
                                <option value="" disabled>Pick a stapleâ€¦</option>
                                {staples.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                              </select>}
                              {staples.length>0 && <button onClick={()=>addRandomStaple(sk)} style={btn(C.green,C.white,{padding:"3px 6px",fontSize:9,borderRadius:4,width:"100%"})}>ğŸ² Random staple</button>}
                              <button onClick={()=>{setEditingSlot("type:"+sk);setSlotInput("");}} style={btn(C.accent,C.white,{padding:"3px 6px",fontSize:9,borderRadius:4,width:"100%"})}>âœï¸ Type new meal</button>
                              <button onClick={()=>setEditingSlot(null)} style={{background:"none",border:"none",fontSize:9,color:C.light,cursor:"pointer",padding:"2px 0"}}>Cancel</button>
                            </div>
                          ) : isTyping ? (
                            <div style={{display:"flex",gap:3,alignItems:"center"}} onClick={e=>e.stopPropagation()}>
                              <input autoFocus value={slotInput} onChange={e=>setSlotInput(e.target.value)}
                                onKeyDown={e=>{if(e.key==="Enter"){e.preventDefault();addSlotMeal(sk);}if(e.key==="Escape"){setEditingSlot(null);setSlotInput("");}}}
                                onBlur={()=>{if(!slotInput.trim()){setEditingSlot(null);setSlotInput("");}}}
                                placeholder="Type a meal..."
                                style={{flex:1,padding:"4px 6px",borderRadius:6,border:`1px solid ${C.border}`,fontSize:11,minWidth:0}} />
                              <button onClick={()=>addSlotMeal(sk)} disabled={!slotInput.trim()}
                                style={btn(C.accent,C.white,{padding:"3px 6px",fontSize:8,borderRadius:4,opacity:!slotInput.trim()?0.5:1})}>
                                Add
                              </button>
                            </div>
                          ) : (
                            <div style={{fontSize:10,color:isTargetable?C.accent:"#b0c4b8",textAlign:"center",padding:"4px 0",fontWeight:isTargetable?600:400}}>{isTargetable?"Tap to place":isPast?"â€”":"Tap to add"}</div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                );
              })}
            </div>
          </div>

          {/* Bottom: actions + suggestions (full-width) */}
          <div style={{padding:"10px 14px 0"}}>
            <div>
              {/* Action bar */}
              <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",marginBottom:10}}>
                <button onClick={generate} disabled={loading} style={btn(C.accent,C.white,{padding:"10px 18px",borderRadius:10,opacity:loading?0.6:1})}>
                  {loading ? <><span className="spinner" style={{marginRight:8}}/>Generatingâ€¦</> : "âœ¨ Generate 10 Ideas"}
                </button>
                {staples.length>0 && <button onClick={rerollStaples} style={btn(C.green,C.white,{padding:"10px 16px",borderRadius:10})}>ğŸ² Re-roll Staples</button>}
                {filledCount>0 && <button onClick={exportPDF} style={btn(C.dark,C.white,{padding:"10px 16px",borderRadius:10})}>ğŸ“„ Export PDF</button>}
                {filledCount>0 && <button onClick={()=>{setAllWeeks(p=>({...p,[wk]:{}}));}} style={btn("transparent",C.red,{padding:"10px 16px",borderRadius:10,border:`1.5px solid ${C.red}`})}>Clear Week</button>}
              </div>

              {error && (
                <div style={{background:"#fdf0ef",border:"1.5px solid #e8a9a5",borderRadius:10,padding:"10px 14px",color:"#8b3a35",fontSize:13,display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,marginBottom:10}}>
                  <span>âš ï¸ {error}</span>
                  <button onClick={()=>{setError(null);generate();}} style={btn(C.red,C.white,{padding:"5px 12px",fontSize:11,flexShrink:0})}>Retry</button>
                </div>
              )}

              {/* Suggestions */}
              {suggestions.length > 0 && (
                <div>
                  <div style={{fontSize:14,fontWeight:700,color:C.dark,marginBottom:10,fontFamily:"'Playfair Display',serif"}}>
                    New Ideas â€” tap a meal, then tap a slot to place it
                  </div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:10}}>
                    {suggestions.filter(s=>!assignedNames.has(s.name)).map(meal=>{
                      const isSel=tapSelected&&tapSelected.meal.name===meal.name&&!tapSelected.fromSlot;
                      return (
                      <div key={meal.id} className={`scard ${isSel?'tap-selected':''}`} draggable onDragStart={e=>onDragStart(e,meal,null)} onDragEnd={onDragEnd}
                        onClick={(e)=>{ if(e.target.closest('button')) return; tapSelectMeal(meal,null); }}
                        style={{background:C.card,border:`1.5px solid ${isSel?C.accent:C.border}`,borderRadius:12,padding:"14px 16px"}}>
                        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:8}}>
                          <div style={{flex:1,minWidth:0}}>
                            <div style={{fontSize:15,fontWeight:700,color:C.dark,marginBottom:3,fontFamily:"'Playfair Display',serif"}}>{meal.name}</div>
                            <div style={{fontSize:12,color:C.light,marginBottom:6,lineHeight:1.5}}>{meal.description}</div>
                          </div>
                          <button onClick={e=>{e.stopPropagation();setModal(meal);}} style={btn(C.green,C.white,{padding:"5px 10px",fontSize:11,flexShrink:0})}>Recipe</button>
                        </div>
                        {meal.whyYoullLikeIt && (
                          <div style={{fontSize:12,color:C.med,lineHeight:1.5,marginBottom:8,background:"#e6ece8",borderRadius:8,padding:"8px 10px",borderLeft:`3px solid ${C.green}`}}>
                            ğŸŒ¿ {meal.whyYoullLikeIt}
                          </div>
                        )}
                        <div style={{display:"flex",gap:8,flexWrap:"wrap",fontSize:11,color:C.light}}>
                          <span>ğŸ³ {meal.cuisine}</span><span>ğŸ”¥ {meal.cookTime}</span>
                          {meal.prepFriendly && <span>ğŸ“¦ Prep-friendly</span>}
                          <span style={{marginLeft:"auto",color:C.accent,fontWeight:600,fontSize:10}}>TAP to select â†’</span>
                        </div>
                      </div>
                      );
                    })}
                  </div>
                  {suggestions.filter(s=>!assignedNames.has(s.name)).length===0 && (
                    <div style={{textAlign:"center",padding:20,color:C.light,fontSize:14}}>All ideas assigned! Generate more if needed.</div>
                  )}
                </div>
              )}

              {/* Empty state */}
              {suggestions.length===0 && filledCount===0 && !loading && (
                <div style={{textAlign:"center",padding:"40px 20px",color:C.light}}>
                  <div style={{fontSize:36,marginBottom:10}}>ğŸ³</div>
                  <div style={{fontFamily:"'Playfair Display',serif",fontSize:18,color:C.dark,marginBottom:6}}>Plan your week</div>
                  <div style={{fontSize:14,maxWidth:360,margin:"0 auto",lineHeight:1.6}}>
                    Staples auto-fill when you navigate to a new week. Hit <strong>Generate 10 Ideas</strong> to discover new dishes and drag them on!
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* â•â•â• SHOP & MANAGE â•â•â• */}
      {page === "manage" && (
        <div style={{padding:"20px 20px 40px",margin:"0 auto"}}>
          {/* Shopping */}
          <h2 style={{fontFamily:"'Playfair Display',serif",color:C.dark,fontSize:22,margin:"0 0 4px"}}>ğŸ›’ Shopping List</h2>
          <p style={{color:C.light,fontSize:13,margin:"0 0 14px"}}>{filledCount>0?`${fmtWeek(currentMonday)} Â· ${getShopList().reduce((n,g)=>n+g.items.length,0)} items`:"Fill your meal plan first"}</p>
          {filledCount>0 ? (()=>{
            const groups=getShopList();
            return (
              <div style={{marginBottom:28}}>
                <div style={{display:"flex",justifyContent:"flex-end",marginBottom:10}}>
                  <button onClick={()=>navigator.clipboard.writeText(`ğŸ›’ Shopping â€“ ${fmtWeek(currentMonday)}\n\n${groups.map(g=>`${g.section}\n${g.items.map(v=>`  â€¢ ${v.name}${v.quantities.length?` (${v.quantities.join(" + ")})`:""}`).join("\n")}`).join("\n\n")}`)} style={btn(C.accent,C.white,{padding:"6px 12px",fontSize:12})}>Copy ğŸ“‹</button>
                </div>
                <div style={{columns:"3 200px",columnGap:20}}>
                {groups.map(g=>(
                  <div key={g.section} style={{breakInside:"avoid",marginBottom:14}}>
                    <div style={{fontSize:12,fontWeight:700,color:C.light,textTransform:"uppercase",letterSpacing:.5,marginBottom:6,paddingBottom:4,borderBottom:`1px solid ${C.border}`}}>{g.section}</div>
                    <div style={{paddingLeft:4}}>
                      {g.items.map(item=>{
                        const ck=`${wk}::${item.key}`;const done=checkedItems[ck];
                        return (
                        <div key={item.key} onClick={()=>setCheckedItems(p=>({...p,[ck]:!p[ck]}))}
                          style={{fontSize:13,color:done?C.light:C.dark,padding:"3px 0",lineHeight:1.5,display:"flex",alignItems:"center",gap:8,cursor:"pointer",textDecoration:done?"line-through":"none",opacity:done?0.5:1}}>
                          <span style={{width:16,height:16,borderRadius:4,border:`1.5px solid ${done?C.green:C.border}`,background:done?C.green:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:10,color:C.white,lineHeight:1}}>{done?"âœ“":""}</span>
                          <span style={{flex:1}}>{item.name}</span>
                          {item.quantities.length>0 && <span style={{fontSize:11,color:C.light,whiteSpace:"nowrap"}}>{item.quantities.join(" + ")}</span>}
                        </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
                </div>
              </div>
            );
          })() : <div style={{background:C.card,borderRadius:14,padding:24,textAlign:"center",border:`1.5px dashed ${C.border}`,color:C.light,fontSize:14,marginBottom:28}}>Assign meals to your week first.</div>}

          {/* Pantry Staples */}
          <h2 style={{fontFamily:"'Playfair Display',serif",color:C.dark,fontSize:22,margin:"0 0 4px"}}>Pantry Staples</h2>
          <p style={{color:C.light,fontSize:13,margin:"0 0 12px"}}>Ingredients you always have â€” excluded from shopping lists</p>
          <div style={{background:C.card,borderRadius:14,padding:"16px 18px",border:`1.5px solid ${C.border}`,marginBottom:28}}>
            {Object.entries(pantry).map(([section,items])=>(
              <div key={section} style={{marginBottom:14}}>
                <div style={{fontSize:11,fontWeight:700,color:C.light,textTransform:"uppercase",letterSpacing:.5,marginBottom:6}}>{section}</div>
                <div style={{display:"flex",flexWrap:"wrap",gap:5}}>
                  {items.map(item=>(
                    <span key={item} style={{background:C.warm,color:C.med,fontSize:12,padding:"4px 10px",borderRadius:16,display:"inline-flex",alignItems:"center",gap:5}}>
                      {item}
                      <button onClick={()=>setPantry(p=>{const s={...p};s[section]=s[section].filter(x=>x!==item);if(s[section].length===0)delete s[section];return s;})} style={{background:"none",border:"none",cursor:"pointer",color:C.light,fontSize:14,lineHeight:1,padding:0}}>Ã—</button>
                    </span>
                  ))}
                </div>
              </div>
            ))}
            {pantryFlat.length===0 && <div style={{fontSize:13,color:C.light,fontStyle:"italic",marginBottom:12}}>No pantry items yet</div>}
            <div style={{display:"flex",gap:6,marginTop:4}}>
              <input
                value={pantryInput}
                onChange={e=>setPantryInput(e.target.value)}
                onKeyDown={e=>{if(e.key==="Enter"){e.preventDefault();const v=pantryInput.trim().toLowerCase();if(v&&!pantryFlat.includes(v)){setPantry(p=>({...p,"Uncategorized":[...(p["Uncategorized"]||[]),v]}));setPantryInput("");};}}}
                placeholder="Add ingredientâ€¦"
                style={{flex:1,padding:"7px 12px",borderRadius:8,border:`1.5px solid ${C.border}`,fontSize:13}}
              />
              <button onClick={()=>{const v=pantryInput.trim().toLowerCase();if(v&&!pantryFlat.includes(v)){setPantry(p=>({...p,"Uncategorized":[...(p["Uncategorized"]||[]),v]}));setPantryInput("");}}} style={btn(C.accent,C.white,{padding:"7px 14px",fontSize:12})}>Add</button>
            </div>
          </div>

          {/* Staples */}
          <h2 style={{fontFamily:"'Playfair Display',serif",color:C.dark,fontSize:22,margin:"0 0 4px"}}>â­ Staples ({staples.length})</h2>
          <p style={{color:C.light,fontSize:13,margin:"0 0 12px"}}>These auto-fill each new week. Goal: ~4 staples + 3 new.</p>
          {staples.map(meal=>(
            <div key={meal.id} style={{background:C.card,border:`1.5px solid ${C.border}`,borderRadius:10,padding:"10px 14px",marginBottom:6,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:14,fontWeight:700,color:C.dark}}>{meal.name}</div>
                {meal.cuisine && <div style={{fontSize:12,color:C.light}}>{meal.cuisine} Â· {meal.cookTime}</div>}
              </div>
              <div style={{display:"flex",gap:4,flexShrink:0}}>
                {meal.ingredients ? (
                  <button onClick={()=>setModal(meal)} style={btn(C.green,C.white,{padding:"4px 8px",fontSize:11})}>Recipe</button>
                ) : (
                  <button onClick={()=>generateRecipe(meal,m=>setStaples(p=>p.map(s=>s.id===meal.id?m:s)))} disabled={expanding===meal.id}
                    style={btn(C.accent,C.white,{padding:"4px 8px",fontSize:11,opacity:expanding===meal.id?0.6:1})}>
                    {expanding===meal.id?<><span className="spinner" style={{width:12,height:12,marginRight:4}}/>Generatingâ€¦</>:"Generate Recipe"}</button>
                )}
                <button onClick={()=>setStaples(p=>p.filter(s=>s.id!==meal.id))} style={btn("transparent",C.red,{padding:"4px 8px",fontSize:11,border:`1px solid ${C.red}`})}>Ã—</button>
              </div>
            </div>
          ))}
          <div style={{background:C.card,border:`1.5px solid ${C.border}`,borderRadius:10,padding:"12px 14px",marginTop:10,marginBottom:6}}>
            <div style={{fontSize:12,color:C.light,marginBottom:8}}>Add a new staple â€” you can generate a full recipe later.</div>
            <div style={{display:"flex",gap:6}}>
              <input value={stapleInput} onChange={e=>setStapleInput(e.target.value)}
                onKeyDown={e=>{if(e.key==="Enter"){e.preventDefault();addStapleDirect();}}}
                placeholder="e.g. Chicken teriyaki bowl"
                style={{flex:1,padding:"8px 12px",borderRadius:8,border:`1.5px solid ${C.border}`,fontSize:13}} />
              <button onClick={addStapleDirect} disabled={!stapleInput.trim()}
                style={btn(C.accent,C.white,{padding:"8px 14px",fontSize:12,opacity:!stapleInput.trim()?0.6:1})}>
                Add Meal
              </button>
            </div>
          </div>

          {/* Prefs */}
          <h2 style={{fontFamily:"'Playfair Display',serif",color:C.dark,fontSize:22,margin:"24px 0 4px"}}>âš™ï¸ Preferences</h2>
          <p style={{color:C.light,fontSize:13,margin:"0 0 12px"}}>Guides AI suggestions. Add your API key to enable generation.</p>
          {!editPrefs ? (
            <div style={{background:C.card,borderRadius:14,padding:18,border:`1.5px solid ${C.border}`}}>
              {/* API Key */}
              <div style={{marginBottom:14,background:"#e6ece8",borderRadius:10,padding:"10px 14px",border:`1.5px solid ${C.border}`}}>
                <div style={{fontSize:10,fontWeight:700,color:C.light,textTransform:"uppercase",letterSpacing:.5,marginBottom:4}}>Anthropic API Key</div>
                {prefs.apiKey ? (
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <span style={{fontSize:13,color:C.green,fontWeight:600}}>âœ“ Key saved</span>
                    <span style={{fontSize:12,color:C.light}}>(sk-...{prefs.apiKey.slice(-4)})</span>
                  </div>
                ) : (
                  <div style={{fontSize:13,color:C.red}}>No key set â€” add one to enable AI dish generation</div>
                )}
              </div>
              {[
                {l:"Primary Cuisines",v:prefs.primaryCuisines.join(", ")},
                {l:"Also Welcome",v:prefs.cuisines.filter(c=>!prefs.primaryCuisines.includes(c)).join(", ")},
                {l:"Dietary / Allergies",v:prefs.dietaryNotes},
                {l:"Cooking Style",v:prefs.cookingStyle},
              ].map((f,i)=>(
                <div key={i} style={{marginBottom:12}}>
                  <div style={{fontSize:10,fontWeight:700,color:C.light,textTransform:"uppercase",letterSpacing:.5,marginBottom:2}}>{f.l}</div>
                  <div style={{fontSize:13,color:C.dark,lineHeight:1.5}}>{f.v}</div>
                </div>
              ))}
              <div style={{marginBottom:12}}>
                <div style={{fontSize:10,fontWeight:700,color:C.light,textTransform:"uppercase",letterSpacing:.5,marginBottom:5}}>Favorite Ingredients</div>
                <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
                  {prefs.favoriteIngredients.map((ing,i)=><span key={i} style={{background:C.warm,color:C.green,fontSize:11,padding:"2px 8px",borderRadius:12}}>{ing}</span>)}
                </div>
              </div>
              <button onClick={()=>setEditPrefs(true)} style={btn(C.accent,C.white,{marginTop:4})}>Edit âœï¸</button>
            </div>
          ) : (
            <div style={{background:C.card,borderRadius:14,padding:18,border:`1.5px solid ${C.border}`}}>
              {/* API Key input */}
              <div style={{marginBottom:14}}>
                <label style={{fontSize:10,fontWeight:700,color:C.light,textTransform:"uppercase",display:"block",marginBottom:4}}>Anthropic API Key</label>
                <div style={{display:"flex",gap:6}}>
                  <input type={apiKeyVisible?"text":"password"} value={prefs.apiKey||""} onChange={e=>setPrefs(p=>({...p,apiKey:e.target.value.trim()}))} placeholder="sk-ant-..." style={{flex:1,padding:"8px 12px",borderRadius:8,border:`1.5px solid ${C.border}`,fontSize:13,fontFamily:"monospace"}} />
                  <button onClick={()=>setApiKeyVisible(!apiKeyVisible)} style={btn("transparent",C.light,{border:`1.5px solid ${C.border}`,padding:"6px 10px",fontSize:12})}>{apiKeyVisible?"Hide":"Show"}</button>
                </div>
                <div style={{fontSize:11,color:C.light,marginTop:4}}>Get one at <a href="https://console.anthropic.com/settings/keys" target="_blank" style={{color:C.accent}}>console.anthropic.com</a>. Stored locally in your browser only.</div>
              </div>
              {[
                {l:"Primary Cuisines",k:"primaryCuisines",t:"arr"},
                {l:"Other Cuisines",k:"_other",t:"special"},
                {l:"Dietary Notes",k:"dietaryNotes",t:"text"},
                {l:"Cooking Style",k:"cookingStyle",t:"text"},
                {l:"Favorite Ingredients",k:"favoriteIngredients",t:"arr"},
              ].map(f=>(
                <div key={f.k} style={{marginBottom:12}}>
                  <label style={{fontSize:10,fontWeight:700,color:C.light,textTransform:"uppercase",display:"block",marginBottom:4}}>{f.l}</label>
                  {f.t==="text" ? <textarea value={prefs[f.k]||""} onChange={e=>setPrefs(p=>({...p,[f.k]:e.target.value}))} rows={2} style={{width:"100%",padding:"8px 12px",borderRadius:8,border:`1.5px solid ${C.border}`,fontSize:13,fontFamily:"'DM Sans',sans-serif",resize:"vertical"}} />
                  : f.t==="arr" ? <input value={(prefs[f.k]||[]).join(", ")} onChange={e=>setPrefs(p=>({...p,[f.k]:e.target.value.split(",").map(s=>s.trim()).filter(Boolean)}))} style={{width:"100%",padding:"8px 12px",borderRadius:8,border:`1.5px solid ${C.border}`,fontSize:13}} />
                  : <input value={prefs.cuisines.filter(c=>!prefs.primaryCuisines.includes(c)).join(", ")} onChange={e=>{const o=e.target.value.split(",").map(s=>s.trim()).filter(Boolean);setPrefs(p=>({...p,cuisines:[...p.primaryCuisines,...o]}));}} style={{width:"100%",padding:"8px 12px",borderRadius:8,border:`1.5px solid ${C.border}`,fontSize:13}} />}
                </div>
              ))}
              <div style={{display:"flex",gap:8}}>
                <button onClick={()=>setEditPrefs(false)} style={btn(C.green,C.white)}>Save âœ“</button>
                <button onClick={()=>setEditPrefs(false)} style={btn("transparent",C.light,{border:`1.5px solid ${C.border}`})}>Cancel</button>
              </div>
            </div>
          )}

          <div style={{background:C.card,borderRadius:12,padding:14,border:`1.5px solid ${C.border}`,marginTop:18}}>
            <div style={{fontFamily:"'Playfair Display',serif",fontSize:14,color:C.dark,marginBottom:4}}>ğŸŒ³ Birch Allergy Reference</div>
            <div style={{fontSize:12,color:C.green,lineHeight:1.7}}>
              <strong>Fruits:</strong> Apples, pears, cherries, peaches, plums, apricots, kiwi Â· <strong>Nuts:</strong> Hazelnuts, almonds, walnuts Â· <strong>Veggies (raw):</strong> Carrots, celery
            </div>
          </div>
        </div>
      )}

      <RecipeModal meal={modal} onClose={()=>setModal(null)} staples={staples} onPromote={promoteToStaple} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
